<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capturador 99 OCR</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🚗</text></svg>">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Capturador 99">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Camera, MapPin, Clock, BarChart3, Upload, Eye, Trash2, CheckCircle } = lucide;

        const CapturadorApp = () => {
            const [corridasCapturadas, setCorridasCapturadas] = useState([]);
            const [printsArmazenados, setPrintsArmazenados] = useState([]);
            const [processandoImagem, setProcessandoImagem] = useState(false);
            const [analises, setAnalises] = useState({});
            const [filtroValor] = useState(35);
            const [ultimoProcessamento, setUltimoProcessamento] = useState(null);

            // Carregar dados salvos
            useEffect(() => {
                const corridasSalvas = localStorage.getItem('corridasOCR99');
                const printsSalvos = localStorage.getItem('printsOCR99');
                
                if (corridasSalvas) {
                    setCorridasCapturadas(JSON.parse(corridasSalvas));
                }
                if (printsSalvos) {
                    setPrintsArmazenados(JSON.parse(printsSalvos));
                }
            }, []);

            // Salvar dados automaticamente
            useEffect(() => {
                localStorage.setItem('corridasOCR99', JSON.stringify(corridasCapturadas));
                localStorage.setItem('printsOCR99', JSON.stringify(printsArmazenados));
                analisarDados();
            }, [corridasCapturadas, printsArmazenados]);

            // Simular OCR
            const extrairDadosOCR = async (arquivo) => {
                setProcessandoImagem(true);
                
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const dadosSimulados = {
                            valor: Math.random() * 50 + 25,
                            origem: [
                                'Shopping Center Norte', 'Aeroporto Guarulhos', 'Vila Madalena',
                                'Pinheiros', 'Brooklin', 'Moema', 'Jardins', 'Centro',
                                'Morumbi', 'Tatuapé', 'Santo Amaro', 'Liberdade'
                            ][Math.floor(Math.random() * 12)],
                            destino: [
                                'Aeroporto Congonhas', 'Shopping Villa-Lobos', 'Alphaville',
                                'Santana', 'Ipiranga', 'Vila Olímpia', 'Itaim Bibi',
                                'São Bernardo', 'Santo André', 'Guarulhos Centro'
                            ][Math.floor(Math.random() * 10)]
                        };
                        
                        setProcessandoImagem(false);
                        resolve(dadosSimulados);
                    }, 2000);
                });
            };

            // Processar screenshot
            const processarScreenshot = async (evento) => {
                const arquivo = evento.target.files[0];
                if (!arquivo) return;

                setUltimoProcessamento(new Date());
                
                try {
                    const dadosExtraidos = await extrairDadosOCR(arquivo);
                    
                    if (dadosExtraidos.valor < filtroValor) {
                        alert(`❌ Corrida de R$ ${dadosExtraidos.valor.toFixed(2)} ignorada (abaixo de R$ ${filtroValor})`);
                        return;
                    }

                    const leitorArquivo = new FileReader();
                    leitorArquivo.onload = (e) => {
                        const imagemBase64 = e.target.result;
                        
                        const novaCorreida = {
                            id: Date.now(),
                            valor: parseFloat(dadosExtraidos.valor.toFixed(2)),
                            origem: dadosExtraidos.origem,
                            destino: dadosExtraidos.destino,
                            dataHora: new Date().toISOString(),
                            diaSemana: new Date().getDay(),
                            hora: new Date().getHours(),
                            screenshot: imagemBase64,
                            extraidoPorOCR: true
                        };

                        setCorridasCapturadas(prev => [novaCorreida, ...prev]);
                        setPrintsArmazenados(prev => [
                            { id: novaCorreida.id, imagem: imagemBase64, dados: dadosExtraidos, dataHora: novaCorreida.dataHora },
                            ...prev
                        ]);

                        alert(`✅ Corrida de R$ ${dadosExtraidos.valor.toFixed(2)} capturada com sucesso!`);
                    };
                    
                    leitorArquivo.readAsDataURL(arquivo);
                    
                } catch (error) {
                    alert('❌ Erro ao processar screenshot');
                }
                
                evento.target.value = '';
            };

            // Análise dos dados
            const analisarDados = () => {
                if (corridasCapturadas.length === 0) return;

                const porOrigem = {};
                const porHora = {};
                const porDiaSemana = {};

                corridasCapturadas.forEach(corrida => {
                    if (!porOrigem[corrida.origem]) {
                        porOrigem[corrida.origem] = { total: 0, count: 0 };
                    }
                    porOrigem[corrida.origem].total += corrida.valor;
                    porOrigem[corrida.origem].count++;

                    if (!porHora[corrida.hora]) {
                        porHora[corrida.hora] = { total: 0, count: 0 };
                    }
                    porHora[corrida.hora].total += corrida.valor;
                    porHora[corrida.hora].count++;

                    const dias = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
                    const nomeDia = dias[corrida.diaSemana];
                    if (!porDiaSemana[nomeDia]) {
                        porDiaSemana[nomeDia] = { total: 0, count: 0 };
                    }
                    porDiaSemana[nomeDia].total += corrida.valor;
                    porDiaSemana[nomeDia].count++;
                });

                const calcularRanking = (dados) => {
                    return Object.entries(dados)
                        .map(([key, value]) => ({
                            nome: key,
                            media: (value.total / value.count).toFixed(2),
                            quantidade: value.count,
                            total: value.total.toFixed(2)
                        }))
                        .sort((a, b) => parseFloat(b.media) - parseFloat(a.media))
                        .slice(0, 5);
                };

                setAnalises({
                    melhoresOrigens: calcularRanking(porOrigem),
                    melhoresHorarios: calcularRanking(porHora),
                    melhoresDias: calcularRanking(porDiaSemana)
                });
            };

            const excluirPrint = (id) => {
                setCorridasCapturadas(prev => prev.filter(c => c.id !== id));
                setPrintsArmazenados(prev => prev.filter(p => p.id !== id));
            };

            return React.createElement('div', {
                className: "min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 p-4"
            }, [
                // Header
                React.createElement('div', {
                    key: 'header',
                    className: "max-w-4xl mx-auto bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-6 mb-6"
                }, [
                    React.createElement('div', {
                        key: 'title',
                        className: "flex items-center gap-3 mb-6"
                    }, [
                        React.createElement('div', {
                            key: 'icon',
                            className: "bg-gradient-to-r from-purple-500 to-pink-500 p-3 rounded-full"
                        }, React.createElement(Camera, { className: "w-8 h-8 text-white" })),
                        React.createElement('div', { key: 'text' }, [
                            React.createElement('h1', {
                                key: 'h1',
                                className: "text-2xl font-bold text-gray-800"
                            }, 'Capturador OCR 99'),
                            React.createElement('p', {
                                key: 'p',
                                className: "text-gray-600"
                            }, 'Screenshot → OCR → Análise Automática')
                        ])
                    ]),
                    
                    // Upload Area
                    React.createElement('div', {
                        key: 'upload',
                        className: "bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6 border-2 border-dashed border-purple-300 text-center"
                    }, [
                        React.createElement(Camera, {
                            key: 'camera',
                            className: "w-16 h-16 text-purple-500 mx-auto mb-4"
                        }),
                        React.createElement('h3', {
                            key: 'h3',
                            className: "text-xl font-bold text-gray-800 mb-2"
                        }, 'Envie o Screenshot da Corrida da 99'),
                        React.createElement('p', {
                            key: 'desc',
                            className: "text-gray-600 mb-4"
                        }, `O app vai ler automaticamente e salvar apenas se for acima de R$ ${filtroValor}`),
                        React.createElement('label', {
                            key: 'label',
                            className: "bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-xl font-bold cursor-pointer hover:from-purple-600 hover:to-pink-600 transition-all inline-flex items-center gap-2"
                        }, [
                            React.createElement(Upload, { key: 'upload-icon', className: "w-5 h-5" }),
                            processandoImagem ? 'Processando OCR...' : 'Selecionar Screenshot',
                            React.createElement('input', {
                                key: 'input',
                                type: 'file',
                                accept: 'image/*',
                                onChange: processarScreenshot,
                                className: 'hidden',
                                disabled: processandoImagem
                            })
                        ]),
                        
                        processandoImagem && React.createElement('div', {
                            key: 'loading',
                            className: "mt-4"
                        }, React.createElement('div', {
                            className: "bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg inline-flex items-center gap-2"
                        }, [
                            React.createElement('div', {
                                key: 'spinner',
                                className: "animate-spin rounded-full h-4 w-4 border-2 border-yellow-600 border-t-transparent"
                            }),
                            'Analisando imagem com OCR...'
                        ]))
                    ]),
                    
                    // Status
                    React.createElement('div', {
                        key: 'status',
                        className: "grid grid-cols-2 md:grid-cols-4 gap-4 mt-6"
                    }, [
                        React.createElement('div', {
                            key: 'stat1',
                            className: "bg-green-50 p-4 rounded-xl text-center"
                        }, [
                            React.createElement('div', {
                                key: 'num',
                                className: "text-2xl font-bold text-green-600"
                            }, corridasCapturadas.length),
                            React.createElement('div', {
                                key: 'label',
                                className: "text-sm text-gray-600"
                            }, 'Corridas Capturadas')
                        ]),
                        React.createElement('div', {
                            key: 'stat2',
                            className: "bg-blue-50 p-4 rounded-xl text-center"
                        }, [
                            React.createElement('div', {
                                key: 'num',
                                className: "text-2xl font-bold text-blue-600"
                            }, `R$ ${filtroValor}+`),
                            React.createElement('div', {
                                key: 'label',
                                className: "text-sm text-gray-600"
                            }, 'Filtro Mínimo')
                        ]),
                        React.createElement('div', {
                            key: 'stat3',
                            className: "bg-purple-50 p-4 rounded-xl text-center"
                        }, [
                            React.createElement('div', {
                                key: 'num',
                                className: "text-2xl font-bold text-purple-600"
                            }, printsArmazenados.length),
                            React.createElement('div', {
                                key: 'label',
                                className: "text-sm text-gray-600"
                            }, 'Prints Salvos')
                        ]),
                        React.createElement('div', {
                            key: 'stat4',
                            className: "bg-orange-50 p-4 rounded-xl text-center"
                        }, [
                            React.createElement('div', {
                                key: 'num',
                                className: "text-2xl font-bold text-orange-600"
                            }, ultimoProcessamento ? ultimoProcessamento.toLocaleTimeString('pt-BR') : '--:--'),
                            React.createElement('div', {
                                key: 'label',
                                className: "text-sm text-gray-600"
                            }, 'Último OCR')
                        ])
                    ])
                ]),
                
                // Análises
                analises.melhoresOrigens && React.createElement('div', {
                    key: 'analises',
                    className: "max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"
                }, [
                    // Melhores Locais
                    React.createElement('div', {
                        key: 'locais',
                        className: "bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6"
                    }, [
                        React.createElement('div', {
                            key: 'header',
                            className: "flex items-center gap-2 mb-4"
                        }, [
                            React.createElement(MapPin, { key: 'icon', className: "w-6 h-6 text-green-600" }),
                            React.createElement('h3', {
                                key: 'title',
                                className: "text-lg font-bold text-gray-800"
                            }, '🎯 Melhores Locais')
                        ]),
                        React.createElement('div', {
                            key: 'list',
                            className: "space-y-3"
                        }, analises.melhoresOrigens.map((local, index) =>
                            React.createElement('div', {
                                key: local.nome,
                                className: "flex items-center justify-between p-3 bg-green-50 rounded-lg border-l-4 border-green-500"
                            }, [
                                React.createElement('div', { key: 'info' }, [
                                    React.createElement('div', {
                                        key: 'nome',
                                        className: "font-semibold text-gray-800 text-sm"
                                    }, local.nome),
                                    React.createElement('div', {
                                        key: 'qtd',
                                        className: "text-xs text-gray-600"
                                    }, `${local.quantidade} corridas`)
                                ]),
                                React.createElement('div', {
                                    key: 'valor',
                                    className: "text-right"
                                }, [
                                    React.createElement('div', {
                                        key: 'media',
                                        className: "font-bold text-green-700"
                                    }, `R$ ${local.media}`),
                                    React.createElement('div', {
                                        key: 'label',
                                        className: "text-xs text-gray-500"
                                    }, 'média')
                                ])
                            ])
                        ))
                    ])
                ]),
                
                // Histórico
                React.createElement('div', {
                    key: 'historico',
                    className: "max-w-4xl mx-auto bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6"
                }, [
                    React.createElement('h3', {
                        key: 'title',
                        className: "text-lg font-bold text-gray-800 mb-4"
                    }, `📸 Prints Capturados (${corridasCapturadas.length})`),
                    
                    corridasCapturadas.length === 0 ?
                        React.createElement('div', {
                            key: 'empty',
                            className: "text-center py-12"
                        }, [
                            React.createElement(Camera, {
                                key: 'icon',
                                className: "w-16 h-16 text-gray-300 mx-auto mb-4"
                            }),
                            React.createElement('p', {
                                key: 'text1',
                                className: "text-gray-500 text-lg"
                            }, 'Nenhum screenshot processado ainda'),
                            React.createElement('p', {
                                key: 'text2',
                                className: "text-gray-400"
                            }, 'Envie uma imagem de corrida da 99 para começar')
                        ])
                    :
                        React.createElement('div', {
                            key: 'list',
                            className: "space-y-4 max-h-96 overflow-y-auto"
                        }, corridasCapturadas.slice(0, 10).map((corrida) =>
                            React.createElement('div', {
                                key: corrida.id,
                                className: "border border-gray-200 rounded-xl p-4"
                            }, [
                                React.createElement('div', {
                                    key: 'header',
                                    className: "flex justify-between items-start mb-3"
                                }, [
                                    React.createElement('div', {
                                        key: 'badges',
                                        className: "flex items-center gap-2"
                                    }, [
                                        React.createElement('div', {
                                            key: 'valor',
                                            className: "bg-gradient-to-r from-green-500 to-blue-500 text-white px-3 py-1 rounded-full font-bold text-sm"
                                        }, `R$ ${corrida.valor.toFixed(2)}`),
                                        React.createElement('div', {
                                            key: 'data',
                                            className: "text-xs text-gray-500"
                                        }, new Date(corrida.dataHora).toLocaleString('pt-BR')),
                                        React.createElement('div', {
                                            key: 'ocr',
                                            className: "bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs"
                                        }, 'OCR')
                                    ]),
                                    React.createElement('button', {
                                        key: 'delete',
                                        onClick: () => excluirPrint(corrida.id),
                                        className: "text-red-500 hover:text-red-700"
                                    }, React.createElement(Trash2, { className: "w-5 h-5" }))
                                ]),
                                React.createElement('div', {
                                    key: 'info',
                                    className: "space-y-2"
                                }, [
                                    React.createElement('div', {
                                        key: 'origem',
                                        className: "flex items-center gap-2"
                                    }, [
                                        React.createElement(MapPin, { className: "w-4 h-4 text-green-600" }),
                                        React.createElement('span', { className: "font-medium text-sm" }, 'De:'),
                                        React.createElement('span', { className: "text-gray-600 text-sm" }, corrida.origem)
                                    ]),
                                    React.createElement('div', {
                                        key: 'destino',
                                        className: "flex items-center gap-2"
                                    }, [
                                        React.createElement(MapPin, { className: "w-4 h-4 text-red-600" }),
                                        React.createElement('span', { className: "font-medium text-sm" }, 'Para:'),
                                        React.createElement('span', { className: "text-gray-600 text-sm" }, corrida.destino)
                                    ])
                                ])
                            ])
                        ))
                ])
            ]);
        };

        // Render
        ReactDOM.render(React.createElement(CapturadorApp), document.getElementById('root'));
        
        // PWA Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW failed'));
            });
        }
    </script>
</body>
</html>
