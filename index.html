<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capturador 99 OCR</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Capturador 99">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.3/dist/tesseract.min.js"></script>
    
    <style>
        .loading {
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card-corrida {
            transition: all 0.3s ease;
        }
        .card-corrida:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .info-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 min-h-screen">
    
    <!-- Header -->
    <div class="max-w-4xl mx-auto p-4">
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-6 mb-6">
            <div class="flex items-center gap-3 mb-6">
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 p-3 rounded-full">
                    <div class="w-8 h-8 text-white text-2xl">üì∑</div>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Capturador OCR 99</h1>
                    <p class="text-gray-600">Screenshot ‚Üí OCR ‚Üí An√°lise Autom√°tica</p>
                </div>
            </div>
            
            <!-- Upload Area -->
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6 border-2 border-dashed border-purple-300 text-center">
                <div class="text-6xl mb-4">üì∏</div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Envie o Screenshot da Corrida da 99</h3>
                <p class="text-gray-600 mb-4">O app vai ler automaticamente e salvar apenas se for acima de R$ 35</p>
                
                <label class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-xl font-bold cursor-pointer hover:from-purple-600 hover:to-pink-600 transition-all inline-flex items-center gap-2">
                    <span>üì§</span>
                    <span id="upload-text">Selecionar Screenshot</span>
                    <input type="file" id="screenshot-input" accept="image/*" class="hidden">
                </label>
                
                <div id="loading" class="mt-4 hidden">
                    <div class="bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg inline-flex items-center gap-2">
                        <div class="loading rounded-full h-4 w-4 border-2 border-yellow-600 border-t-transparent"></div>
                        <span id="ocr-progress-text">Analisando imagem com OCR...</span>
                    </div>
                </div>

                <!-- Debug OCR Text -->
                <div id="debug-ocr" class="mt-4 hidden">
                    <details class="bg-gray-100 p-3 rounded-lg text-left">
                        <summary class="cursor-pointer text-sm font-medium text-gray-700">Ver texto extra√≠do pelo OCR</summary>
                        <pre id="ocr-text" class="mt-2 text-xs text-gray-600 whitespace-pre-wrap max-h-40 overflow-y-auto"></pre>
                    </details>
                </div>
            </div>

            <!-- Status -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                <div class="bg-green-50 p-4 rounded-xl text-center">
                    <div class="text-2xl font-bold text-green-600" id="total-corridas">0</div>
                    <div class="text-sm text-gray-600">Corridas Capturadas</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl text-center">
                    <div class="text-2xl font-bold text-blue-600">R$ 35+</div>
                    <div class="text-sm text-gray-600">Filtro M√≠nimo</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl text-center">
                    <div class="text-2xl font-bold text-purple-600" id="total-prints">0</div>
                    <div class="text-sm text-gray-600">Prints Salvos</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-xl text-center">
                    <div class="text-2xl font-bold text-orange-600" id="ultimo-ocr">--:--</div>
                    <div class="text-sm text-gray-600">√öltimo OCR</div>
                </div>
            </div>
        </div>

        <!-- An√°lises -->
        <div id="analises" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 hidden">
            <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">üìç</span>
                    <h3 class="text-lg font-bold text-gray-800">üéØ Melhores Locais</h3>
                </div>
                <div id="melhores-locais" class="space-y-3">
                    <!-- Ser√° preenchido via JavaScript -->
                </div>
            </div>

            <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">‚è∞</span>
                    <h3 class="text-lg font-bold text-gray-800">‚è∞ Melhores Hor√°rios</h3>
                </div>
                <div id="melhores-horarios" class="space-y-3">
                    <!-- Ser√° preenchido via JavaScript -->
                </div>
            </div>

            <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">üìä</span>
                    <h3 class="text-lg font-bold text-gray-800">üìÖ Melhores Dias</h3>
                </div>
                <div id="melhores-dias" class="space-y-3">
                    <!-- Ser√° preenchido via JavaScript -->
                </div>
            </div>
        </div>

        <!-- Hist√≥rico -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">üì∏ Prints Capturados (<span id="count-historico">0</span>)</h3>
                <button id="limpar-tudo" class="text-sm text-red-500 hover:text-red-700 px-3 py-1 rounded-lg bg-red-50">
                    üóëÔ∏è Limpar tudo
                </button>
            </div>
            
            <div id="historico-vazio" class="text-center py-12">
                <div class="text-6xl mb-4">üì∑</div>
                <p class="text-gray-500 text-lg">Nenhum screenshot processado ainda</p>
                <p class="text-gray-400">Envie uma imagem de corrida da 99 para come√ßar</p>
            </div>

            <div id="historico-list" class="space-y-4 hidden">
                <!-- Ser√° preenchido via JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Estado da aplica√ß√£o
        let corridasCapturadas = [];
        let printsArmazenados = [];
        const filtroValor = 35;

        // Elementos DOM
        const uploadInput = document.getElementById('screenshot-input');
        const uploadText = document.getElementById('upload-text');
        const loading = document.getElementById('loading');
        const progressText = document.getElementById('ocr-progress-text');
        const totalCorridas = document.getElementById('total-corridas');
        const totalPrints = document.getElementById('total-prints');
        const ultimoOCR = document.getElementById('ultimo-ocr');
        const analises = document.getElementById('analises');
        const historicoVazio = document.getElementById('historico-vazio');
        const historicoList = document.getElementById('historico-list');
        const countHistorico = document.getElementById('count-historico');
        const limparTudoBtn = document.getElementById('limpar-tudo');
        const debugOcr = document.getElementById('debug-ocr');
        const ocrText = document.getElementById('ocr-text');

        // Carregar dados salvos
        function carregarDados() {
            const corridasSalvas = localStorage.getItem('corridasOCR99');
            const printsSalvos = localStorage.getItem('printsOCR99');
            
            if (corridasSalvas) {
                corridasCapturadas = JSON.parse(corridasSalvas);
            }
            if (printsSalvos) {
                printsArmazenados = JSON.parse(printsSalvos);
            }
            
            atualizarInterface();
        }

        // Salvar dados
        function salvarDados() {
            localStorage.setItem('corridasOCR99', JSON.stringify(corridasCapturadas));
            localStorage.setItem('printsOCR99', JSON.stringify(printsArmazenados));
        }

        // FUN√á√ÉO MELHORADA DE EXTRA√á√ÉO - VERS√ÉO CORRIGIDA
        function extrairDadosCorrida(textoOCR) {
            console.log("=== TEXTO OCR COMPLETO ===");
            console.log(textoOCR);
            console.log("=========================");

            // Normalizar o texto
            let texto = textoOCR.replace(/\r?\n/g, ' ').replace(/\s+/g, ' ').trim();
            
            // 1. EXTRAIR VALOR - M√öLTIPLOS PADR√ïES MELHORADOS
            let valor = null;
            
            // Padr√£o 1: R$ seguido de n√∫mero (mais comum)
            const valorPatterns = [
                /R\$\s*(\d+(?:[.,]\d{2})?)/gi,
                /rs\s*(\d+(?:[.,]\d{2})?)/gi,
                /r\s+(\d+(?:[.,]\d{2})?)/gi,
                /(\d+,\d{2})\s*(?=.*(?:expresso|pop|km))/gi,
                /(\d+\.\d{2})\s*(?=.*(?:expresso|pop|km))/gi
            ];

            for (const pattern of valorPatterns) {
                const matches = [...textoOCR.matchAll(pattern)];
                if (matches.length > 0) {
                    // Pegar o maior valor encontrado (provavelmente o da corrida)
                    const valores = matches.map(m => parseFloat(m[1].replace(',', '.')))
                        .filter(v => v >= 10 && v <= 200); // Valores realistas para corridas
                    
                    if (valores.length > 0) {
                        valor = Math.max(...valores);
                        console.log(`Valor encontrado: R$ ${valor} (padr√£o: ${pattern})`);
                        break;
                    }
                }
            }

            // Fallback: buscar n√∫meros que parecem valores de corrida
            if (!valor) {
                const numerosSoltos = textoOCR.match(/\b(\d{2},\d{2}|\d{2}\.\d{2})\b/g);
                if (numerosSoltos) {
                    const possiveisValores = numerosSoltos
                        .map(n => parseFloat(n.replace(',', '.')))
                        .filter(v => v >= 15 && v <= 150);
                    
                    if (possiveisValores.length > 0) {
                        valor = Math.max(...possiveisValores);
                        console.log(`Valor fallback: R$ ${valor}`);
                    }
                }
            }

            // 2. EXTRAIR AVALIA√á√ÉO E CORRIDAS DO PASSAGEIRO
            let avaliacao = null;
            let corridasPassageiro = null;
            
            const avaliacaoPatterns = [
                /(\d+[.,]\d+)\s*[¬∑‚Ä¢\-]\s*(\d+)\s*corridas?/i,
                /(\d+[.,]\d+)\s*(\d+)\s*corridas?/i,
                /[‚òÖ‚≠ê]\s*(\d+[.,]\d+).*?(\d+)\s*corridas?/i
            ];

            for (const pattern of avaliacaoPatterns) {
                const match = textoOCR.match(pattern);
                if (match) {
                    avaliacao = match[1].replace(',', '.');
                    corridasPassageiro = match[2] + ' corridas';
                    console.log(`Avalia√ß√£o: ${avaliacao}, Corridas: ${corridasPassageiro}`);
                    break;
                }
            }

            // 3. EXTRAIR ROTAS COM MELHOR PRECIS√ÉO
            const rotas = [];
            
            // Padr√£o melhorado para capturar rotas com endere√ßos completos
            const rotaPatterns = [
                /(\d+)\s*min\s*\(([0-9.,]+)\s*km\)\s*([^(\n\r]+?)(?=\s*\d+\s*min|\s*$)/gi,
                /([üîÑ‚¨Ü‚¨á‚Üë‚Üìüîµüü¢])\s*(\d+)\s*min\s*\(([0-9.,]+)\s*km\)\s*([^(\n\r]+?)(?=\s*[üîÑ‚¨Ü‚¨á‚Üë‚Üìüîµüü¢]|\s*$)/gi,
                /(\d+min)\s*\(([0-9.,]+km)\)\s*([^\n\r]+)/gi
            ];

            for (const pattern of rotaPatterns) {
                let match;
                while ((match = pattern.exec(textoOCR)) !== null) {
                    let endereco = '';
                    let tempo = '';
                    let distancia = '';

                    if (match.length === 4 && !isNaN(match[1])) {
                        // Padr√£o: tempo min (distancia km) endere√ßo
                        tempo = match[1] + 'min';
                        distancia = match[2].replace(',', '.') + 'km';
                        endereco = match[3];
                    } else if (match.length === 5) {
                        // Padr√£o com √≠cone
                        tempo = match[2] + 'min';
                        distancia = match[3].replace(',', '.') + 'km';
                        endereco = match[4];
                    } else if (match.length === 4) {
                        // Padr√£o simples
                        tempo = match[1];
                        distancia = match[2];
                        endereco = match[3];
                    }

                    // Limpar o endere√ßo
                    endereco = endereco
                        .replace(/^\W+|\W+$/g, '')
                        .replace(/\s+/g, ' ')
                        .replace(/\d+\s*parada\s*\(\s*s?\s*\)/gi, '')
                        .trim();

                    if (endereco.length > 5 && tempo && distancia) {
                        rotas.push({
                            tempo: tempo,
                            distancia: distancia,
                            endereco: endereco
                        });
                        console.log(`Rota encontrada: ${tempo} ${distancia} - ${endereco}`);
                    }
                }
            }

            // 4. DETERMINAR ORIGEM E DESTINO
            let origem = "Origem n√£o identificada";
            let destino = "Destino n√£o identificado";
            let distanciaPegar = null;
            let distanciaCorrida = null;
            let tempoPegar = null;
            let tempoCorrida = null;

            console.log(`Total de rotas encontradas: ${rotas.length}`);

            if (rotas.length >= 2) {
                // Primeira rota: motorista at√© o passageiro
                origem = rotas[0].endereco;
                distanciaPegar = rotas[0].distancia;
                tempoPegar = rotas[0].tempo;
                
                // √öltima rota: viagem do passageiro
                destino = rotas[rotas.length - 1].endereco;
                distanciaCorrida = rotas[rotas.length - 1].distancia;
                tempoCorrida = rotas[rotas.length - 1].tempo;
                
                console.log(`M√∫ltiplas rotas - Origem: ${origem}, Destino: ${destino}`);
            } else if (rotas.length === 1) {
                // Apenas uma rota: consideramos como viagem do passageiro
                destino = rotas[0].endereco;
                distanciaCorrida = rotas[0].distancia;
                tempoCorrida = rotas[0].tempo;
                origem = "Embarque pr√≥ximo";
                
                console.log(`Uma rota - Destino: ${destino}`);
            } else {
                // Fallback: tentar extrair endere√ßos por outros m√©todos
                const enderecoPatterns = [
                    /(?:rua|av|avenida|estrada|rod|rodovia)\s+[^,\n\r]+/gi,
                    /[A-Z][a-z√°√†√¢√£√©√®√™√≠√Ø√≥√¥√µ√∂√∫√ß√±\s]+(?:,\s*\d+)/gi
                ];

                for (const pattern of enderecoPatterns) {
                    const enderecos = textoOCR.match(pattern);
                    if (enderecos && enderecos.length >= 1) {
                        if (origem === "Origem n√£o identificada") {
                            origem = enderecos[0].trim();
                        }
                        if (enderecos.length >= 2 && destino === "Destino n√£o identificado") {
                            destino = enderecos[1].trim();
                        }
                    }
                }
            }

            // 5. LIMPEZA FINAL DOS CAMPOS
            origem = origem.replace(/^\W+|\W+$/g, '').trim();
            destino = destino.replace(/^\W+|\W+$/g, '').trim();
            
            // Truncar endere√ßos muito longos
            if (origem.length > 50) origem = origem.substring(0, 47) + "...";
            if (destino.length > 50) destino = destino.substring(0, 47) + "...";

            const resultado = {
                valor: valor,
                avaliacao: avaliacao,
                corridasPassageiro: corridasPassageiro,
                tempoPegar: tempoPegar,
                distanciaPegar: distanciaPegar,
                tempoCorrida: tempoCorrida,
                distanciaCorrida: distanciaCorrida,
                origem: origem,
                destino: destino,
                dataHora: new Date().toISOString(),
                diaSemana: new Date().getDay(),
                hora: new Date().getHours()
            };

            console.log("=== RESULTADO FINAL ===");
            console.log(resultado);
            console.log("======================");

            return resultado;
        }

        // Processar screenshot com OCR real
        async function processarScreenshot(arquivo) {
            if (!arquivo) return;

            loading.classList.remove('hidden');
            debugOcr.classList.add('hidden');
            progressText.textContent = "Analisando imagem com OCR...";
            uploadText.textContent = 'Processando...';

            try {
                const { data: { text } } = await Tesseract.recognize(
                    arquivo,
                    'por',
                    {
                        logger: progresso => {
                            if (progresso.status === 'recognizing text') {
                                const progressoPorcentagem = Math.round(progresso.progress * 100);
                                progressText.textContent = `OCR: ${progressoPorcentagem}%`;
                            }
                        }
                    }
                );

                console.log("Texto extra√≠do pelo OCR:", text);
                
                // Mostrar texto do OCR para debug
                ocrText.textContent = text;
                debugOcr.classList.remove('hidden');
                
                const dados = extrairDadosCorrida(text);
                
                if (!dados.valor) {
                    alert("‚ùå N√£o foi poss√≠vel identificar o valor da corrida. Verifique se √© uma tela de corrida da 99 v√°lida.");
                    return;
                }

                if (dados.valor < filtroValor) {
                    alert(`‚ùå Corrida de R$ ${dados.valor.toFixed(2)} ignorada (abaixo de R$ ${filtroValor})`);
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const novaCorrida = {
                        id: Date.now(),
                        valor: dados.valor,
                        avaliacao: dados.avaliacao,
                        corridasPassageiro: dados.corridasPassageiro,
                        tempoPegar: dados.tempoPegar,
                        distanciaPegar: dados.distanciaPegar,
                        tempoCorrida: dados.tempoCorrida,
                        distanciaCorrida: dados.distanciaCorrida,
                        origem: dados.origem,
                        destino: dados.destino,
                        dataHora: dados.dataHora,
                        diaSemana: dados.diaSemana,
                        hora: dados.hora,
                        screenshot: e.target.result
                    };

                    corridasCapturadas.unshift(novaCorrida);
                    printsArmazenados.unshift({
                        id: novaCorrida.id,
                        imagem: e.target.result,
                        dados: dados,
                        dataHora: novaCorrida.dataHora
                    });

                    salvarDados();
                    atualizarInterface();
                    
                    alert(`‚úÖ Corrida de R$ ${dados.valor.toFixed(2)} capturada com sucesso!\n\nOrigem: ${dados.origem}\nDestino: ${dados.destino}${dados.tempoCorrida ? '\nTempo: ' + dados.tempoCorrida : ''}${dados.distanciaCorrida ? '\nDist√¢ncia: ' + dados.distanciaCorrida : ''}`);
                };
                
                reader.readAsDataURL(arquivo);

            } catch (error) {
                alert('‚ùå Erro ao processar screenshot. Tente novamente com uma imagem mais n√≠tida.');
                console.error("Erro no OCR:", error);
            } finally {
                loading.classList.add('hidden');
                uploadText.textContent = 'Selecionar Screenshot';
                uploadInput.value = '';
            }
        }

        // Atualizar a interface
        function atualizarInterface() {
            totalCorridas.textContent = corridasCapturadas.length;
            totalPrints.textContent = printsArmazenados.length;
            countHistorico.textContent = corridasCapturadas.length;
            ultimoOCR.textContent = corridasCapturadas.length > 0 ? 
                new Date(corridasCapturadas[0].dataHora).toLocaleTimeString('pt-BR') : '--:--';

            if (corridasCapturadas.length === 0) {
                historicoVazio.classList.remove('hidden');
                historicoList.classList.add('hidden');
                analises.classList.add('hidden');
            } else {
                historicoVazio.classList.add('hidden');
                historicoList.classList.remove('hidden');
                analises.classList.remove('hidden');
                renderizarHistorico();
                renderizarAnalises();
            }
        }

        // Renderizar hist√≥rico de corridas
        function renderizarHistorico() {
            historicoList.innerHTML = corridasCapturadas.slice(0, 10).map(corrida => `
                <div class="card-corrida border border-gray-200 rounded-xl p-4 bg-white">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2 flex-wrap">
                            <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-1 rounded-full font-bold text-sm">
                                R$ ${corrida.valor.toFixed(2)}
                            </div>
                            <div class="text-xs text-gray-500">
                                ${new Date(corrida.dataHora).toLocaleString('pt-BR')}
                            </div>
                            ${corrida.avaliacao ? `
                            <div class="info-badge bg-yellow-100 text-yellow-800">
                                ‚≠ê ${corrida.avaliacao} ${corrida.corridasPassageiro ? '('+corrida.corridasPassageiro+')' : ''}
                            </div>
                            ` : ''}
                            ${corrida.tempoCorrida ? `
                            <div class="info-badge bg-blue-100 text-blue-800">
                                ‚è±Ô∏è ${corrida.tempoCorrida}
                            </div>
                            ` : ''}
                            ${corrida.distanciaCorrida ? `
                            <div class="info-badge bg-green-100 text-green-800">
                                üìè ${corrida.distanciaCorrida}
                            </div>
                            ` : ''}
                        </div>
                        <button onclick="excluirCorrida(${corrida.id})" class="text-red-500 hover:text-red-700">
                            üóëÔ∏è
                        </button>
                    </div>
                    <div class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <div class="flex items-start gap-2 text-sm">
                                    <span class="text-green-600 mt-1">üìç</span>
                                    <div>
                                        <div class="font-medium">Origem:</div>
                                        <div class="text-gray-600">${corrida.origem}</div>
                                    </div>
                                </div>
                                <div class="flex items-start gap-2 text-sm">
                                    <span class="text-red-600 mt-1">üìç</span>
                                    <div>
                                        <div class="font-medium">Destino:</div>
                                        <div class="text-gray-600">${corrida.destino}</div>
                                    </div>
                                </div>
                            </div>
                            ${corrida.screenshot ? `
                            <div class="flex justify-end">
                                <img src="${corrida.screenshot}" alt="Screenshot" 
                                     class="w-24 h-24 object-cover rounded-lg border-2 border-gray-200 cursor-pointer hover:scale-110 transition-transform"
                                     onclick="window.open('${corrida.screenshot}', '_blank')">
                            </div>
                            ` : ''}
                        </div>
                        
                        ${corrida.distanciaPegar ? `
                        <div class="flex items-center gap-2 text-sm bg-indigo-50 p-3 rounded-lg">
                            <span class="text-indigo-600">üöó</span>
                            <span class="font-medium">Dist√¢ncia para pegar PS:</span>
                            <span class="text-gray-600">${corrida.distanciaPegar} ${corrida.tempoPegar ? '('+corrida.tempoPegar+')' : ''}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Renderizar an√°lises (estat√≠sticas)
        function renderizarAnalises() {
            const porDestino = {};
            const porOrigem = {};
            const porHora = {};
            const porDia = {};

            corridasCapturadas.forEach(corrida => {
                const destinoKey = corrida.destino || "Sem destino";
                const origemKey = corrida.origem || "Sem origem";
                
                // Estat√≠sticas por destino
                if (!porDestino[destinoKey]) porDestino[destinoKey] = { total: 0, count: 0 };
                porDestino[destinoKey].total += corrida.valor;
                porDestino[destinoKey].count++;
                
                // Estat√≠sticas por origem
                if (!porOrigem[origemKey]) porOrigem[origemKey] = { total: 0, count: 0 };
                porOrigem[origemKey].total += corrida.valor;
                porOrigem[origemKey].count++;

                // Estat√≠sticas por hora
                if (!porHora[corrida.hora]) porHora[corrida.hora] = { total: 0, count: 0 };
                porHora[corrida.hora].total += corrida.valor;
                porHora[corrida.hora].count++;

                // Estat√≠sticas por dia
                const dias = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
                const nomeDia = dias[corrida.diaSemana];
                if (!porDia[nomeDia]) porDia[nomeDia] = { total: 0, count: 0 };
                porDia[nomeDia].total += corrida.valor;
                porDia[nomeDia].count++;
            });

            const criarRanking = (dados) => Object.entries(dados)
                .map(([key, value]) => ({
                    nome: key,
                    media: (value.total / value.count).toFixed(2),
                    quantidade: value.count
                }))
                .sort((a, b) => parseFloat(b.media) - parseFloat(a.media))
                .slice(0, 5);

            const renderizarCard = (items, containerId) => {
                const container = document.getElementById(containerId);
                if (items.length === 0) {
                    container.innerHTML = '<div class="text-center py-4 text-gray-500">Sem dados suficientes</div>';
                    return;
                }
                
                container.innerHTML = items.map(item => `
                    <div class="flex items-center justify-between p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-l-4 border-indigo-500 mb-2">
                        <div class="w-3/4">
                            <div class="font-semibold text-gray-800 text-sm truncate">${item.nome}</div>
                            <div class="text-xs text-gray-600">${item.quantidade} corridas</div>
                        </div>
                        <div class="text-right w-1/4">
                            <div class="font-bold text-indigo-700">R$ ${item.media}</div>
                            <div class="text-xs text-gray-500">m√©dia</div>
                        </div>
                    </div>
                `).join('');
            };

            renderizarCard(criarRanking(porDestino), 'melhores-locais');
            renderizarCard(criarRanking(porHora).map(h => ({...h, nome: h.nome + ':00h'})), 'melhores-horarios');
            renderizarCard(criarRanking(porDia), 'melhores-dias');
        }

        // Excluir uma corrida
        function excluirCorrida(id) {
            if (confirm('Deseja excluir esta corrida?')) {
                corridasCapturadas = corridasCapturadas.filter(c => c.id !== id);
                printsArmazenados = printsArmazenados.filter(p => p.id !== id);
                salvarDados();
                atualizarInterface();
            }
        }

        // Limpar todos os dados
        function limparTudo() {
            if (confirm('Deseja realmente excluir TODOS os dados?')) {
                corridasCapturadas = [];
                printsArmazenados = [];
                salvarDados();
                atualizarInterface();
            }
        }

        // Event listeners
        uploadInput.addEventListener('change', (e) => {
            const arquivo = e.target.files[0];
            if (arquivo) {
                processarScreenshot(arquivo);
            }
        });
        
        limparTudoBtn.addEventListener('click', limparTudo);

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            carregarDados();
            
            // PWA Installation
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(() => console.log('Service Worker registrado'))
                    .catch(() => console.log('Service Worker falhou'));
            }
        });
    </script>
</body>
</html>
