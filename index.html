<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capturador 99 OCR</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Capturador 99">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .loading {
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 min-h-screen">
    
    <!-- Header -->
    <div class="max-w-4xl mx-auto p-4">
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-6 mb-6">
            <div class="flex items-center gap-3 mb-6">
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 p-3 rounded-full">
                    <div class="w-8 h-8 text-white text-2xl">üì∑</div>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Capturador OCR 99</h1>
                    <p class="text-gray-600">Screenshot ‚Üí OCR ‚Üí An√°lise Autom√°tica</p>
                </div>
            </div>
            
            <!-- Upload Area -->
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6 border-2 border-dashed border-purple-300 text-center">
                <div class="text-6xl mb-4">üì∏</div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Envie o Screenshot da Corrida da 99</h3>
                <p class="text-gray-600 mb-4">O app vai ler automaticamente e salvar apenas se for acima de R$ 35</p>
                
                <label class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-xl font-bold cursor-pointer hover:from-purple-600 hover:to-pink-600 transition-all inline-flex items-center gap-2">
                    <span>üì§</span>
                    <span id="upload-text">Selecionar Screenshot</span>
                    <input type="file" id="screenshot-input" accept="image/*" class="hidden">
                </label>
                
                <div id="loading" class="mt-4 hidden">
                    <div class="bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg inline-flex items-center gap-2">
                        <div class="loading rounded-full h-4 w-4 border-2 border-yellow-600 border-t-transparent"></div>
                        Analisando imagem com OCR...
                    </div>
                </div>
            </div>

            <!-- Status -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                <div class="bg-green-50 p-4 rounded-xl text-center">
                    <div class="text-2xl font-bold text-green-600" id="total-corridas">0</div>
                    <div class="text-sm text-gray-600">Corridas Capturadas</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl text-center">
                    <div class="text-2xl font-bold text-blue-600">R$ 35+</div>
                    <div class="text-sm text-gray-600">Filtro M√≠nimo</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl text-center">
                    <div class="text-2xl font-bold text-purple-600" id="total-prints">0</div>
                    <div class="text-sm text-gray-600">Prints Salvos</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-xl text-center">
                    <div class="text-2xl font-bold text-orange-600" id="ultimo-ocr">--:--</div>
                    <div class="text-sm text-gray-600">√öltimo OCR</div>
                </div>
            </div>
        </div>

        <!-- An√°lises -->
        <div id="analises" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 hidden">
            <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">üìç</span>
                    <h3 class="text-lg font-bold text-gray-800">üéØ Melhores Locais</h3>
                </div>
                <div id="melhores-locais" class="space-y-3">
                    <!-- Ser√° preenchido via JavaScript -->
                </div>
            </div>

            <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">‚è∞</span>
                    <h3 class="text-lg font-bold text-gray-800">‚è∞ Melhores Hor√°rios</h3>
                </div>
                <div id="melhores-horarios" class="space-y-3">
                    <!-- Ser√° preenchido via JavaScript -->
                </div>
            </div>

            <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">üìä</span>
                    <h3 class="text-lg font-bold text-gray-800">üìÖ Melhores Dias</h3>
                </div>
                <div id="melhores-dias" class="space-y-3">
                    <!-- Ser√° preenchido via JavaScript -->
                </div>
            </div>
        </div>

        <!-- Hist√≥rico -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">üì∏ Prints Capturados (<span id="count-historico">0</span>)</h3>
            
            <div id="historico-vazio" class="text-center py-12">
                <div class="text-6xl mb-4">üì∑</div>
                <p class="text-gray-500 text-lg">Nenhum screenshot processado ainda</p>
                <p class="text-gray-400">Envie uma imagem de corrida da 99 para come√ßar</p>
            </div>

            <div id="historico-list" class="space-y-4 hidden">
                <!-- Ser√° preenchido via JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Estado da aplica√ß√£o
        let corridasCapturadas = [];
        let printsArmazenados = [];
        const filtroValor = 35;

        // Elementos DOM
        const uploadInput = document.getElementById('screenshot-input');
        const uploadText = document.getElementById('upload-text');
        const loading = document.getElementById('loading');
        const totalCorridas = document.getElementById('total-corridas');
        const totalPrints = document.getElementById('total-prints');
        const ultimoOCR = document.getElementById('ultimo-ocr');
        const analises = document.getElementById('analises');
        const historicoVazio = document.getElementById('historico-vazio');
        const historicoList = document.getElementById('historico-list');
        const countHistorico = document.getElementById('count-historico');

        // Carregar dados salvos
        function carregarDados() {
            const corridasSalvas = localStorage.getItem('corridasOCR99');
            const printsSalvos = localStorage.getItem('printsOCR99');
            
            if (corridasSalvas) {
                corridasCapturadas = JSON.parse(corridasSalvas);
            }
            if (printsSalvos) {
                printsArmazenados = JSON.parse(printsSalvos);
            }
            
            atualizarInterface();
        }

        // Salvar dados
        function salvarDados() {
            localStorage.setItem('corridasOCR99', JSON.stringify(corridasCapturadas));
            localStorage.setItem('printsOCR99', JSON.stringify(printsArmazenados));
        }

        // Simular OCR
        async function extrairDadosOCR(arquivo) {
            const locais = [
                'Shopping Center Norte', 'Aeroporto Guarulhos', 'Vila Madalena',
                'Pinheiros', 'Brooklin', 'Moema', 'Jardins', 'Centro',
                'Morumbi', 'Tatuap√©', 'Santo Amaro', 'Liberdade'
            ];
            
            const destinos = [
                'Aeroporto Congonhas', 'Shopping Villa-Lobos', 'Alphaville',
                'Santana', 'Ipiranga', 'Vila Ol√≠mpia', 'Itaim Bibi',
                'S√£o Bernardo', 'Santo Andr√©', 'Guarulhos Centro'
            ];

            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve({
                        valor: Math.random() * 50 + 25,
                        origem: locais[Math.floor(Math.random() * locais.length)],
                        destino: destinos[Math.floor(Math.random() * destinos.length)]
                    });
                }, 2000);
            });
        }

        // Processar screenshot
        async function processarScreenshot(arquivo) {
            if (!arquivo) return;

            loading.classList.remove('hidden');
            uploadText.textContent = 'Processando OCR...';

            try {
                const dados = await extrairDadosOCR(arquivo);
                
                if (dados.valor < filtroValor) {
                    alert(`‚ùå Corrida de R$ ${dados.valor.toFixed(2)} ignorada (abaixo de R$ ${filtroValor})`);
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const novaCorreida = {
                        id: Date.now(),
                        valor: parseFloat(dados.valor.toFixed(2)),
                        origem: dados.origem,
                        destino: dados.destino,
                        dataHora: new Date().toISOString(),
                        diaSemana: new Date().getDay(),
                        hora: new Date().getHours(),
                        screenshot: e.target.result
                    };

                    corridasCapturadas.unshift(novaCorreida);
                    printsArmazenados.unshift({
                        id: novaCorreida.id,
                        imagem: e.target.result,
                        dados: dados,
                        dataHora: novaCorreida.dataHora
                    });

                    salvarDados();
                    atualizarInterface();
                    
                    alert(`‚úÖ Corrida de R$ ${dados.valor.toFixed(2)} capturada com sucesso!`);
                };
                
                reader.readAsDataURL(arquivo);

            } catch (error) {
                alert('‚ùå Erro ao processar screenshot');
                console.error(error);
            } finally {
                loading.classList.add('hidden');
                uploadText.textContent = 'Selecionar Screenshot';
                uploadInput.value = '';
            }
        }

        // Atualizar interface
        function atualizarInterface() {
            totalCorridas.textContent = corridasCapturadas.length;
            totalPrints.textContent = printsArmazenados.length;
            countHistorico.textContent = corridasCapturadas.length;
            ultimoOCR.textContent = corridasCapturadas.length > 0 ? 
                new Date(corridasCapturadas[0].dataHora).toLocaleTimeString('pt-BR') : '--:--';

            // Mostrar/ocultar hist√≥rico
            if (corridasCapturadas.length === 0) {
                historicoVazio.classList.remove('hidden');
                historicoList.classList.add('hidden');
                analises.classList.add('hidden');
            } else {
                historicoVazio.classList.add('hidden');
                historicoList.classList.remove('hidden');
                analises.classList.remove('hidden');
                
                renderizarHistorico();
                renderizarAnalises();
            }
        }

        // Renderizar hist√≥rico
        function renderizarHistorico() {
            historicoList.innerHTML = corridasCapturadas.slice(0, 10).map(corrida => `
                <div class="border border-gray-200 rounded-xl p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2 flex-wrap">
                            <div class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-3 py-1 rounded-full font-bold text-sm">
                                R$ ${corrida.valor.toFixed(2)}
                            </div>
                            <div class="text-xs text-gray-500">
                                ${new Date(corrida.dataHora).toLocaleString('pt-BR')}
                            </div>
                            <div class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs">
                                OCR
                            </div>
                            <div class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">
                                R$ 35+
                            </div>
                        </div>
                        <button onclick="excluirCorreida(${corrida.id})" class="text-red-500 hover:text-red-700">
                            üóëÔ∏è
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <div class="flex items-center gap-2 text-sm">
                                <span class="text-green-600">üìç</span>
                                <span class="font-medium">De:</span>
                                <span class="text-gray-600">${corrida.origem}</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm">
                                <span class="text-red-600">üìç</span>
                                <span class="font-medium">Para:</span>
                                <span class="text-gray-600">${corrida.destino}</span>
                            </div>
                        </div>
                        ${corrida.screenshot ? `
                        <div class="flex justify-end">
                            <img src="${corrida.screenshot}" alt="Screenshot" 
                                 class="w-20 h-20 object-cover rounded-lg border-2 border-gray-200 cursor-pointer hover:scale-110 transition-transform"
                                 onclick="window.open('${corrida.screenshot}', '_blank')">
                        </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Renderizar an√°lises
        function renderizarAnalises() {
            const porOrigem = {};
            const porHora = {};
            const porDia = {};

            corridasCapturadas.forEach(corrida => {
                // Por origem
                if (!porOrigem[corrida.origem]) {
                    porOrigem[corrida.origem] = { total: 0, count: 0 };
                }
                porOrigem[corrida.origem].total += corrida.valor;
                porOrigem[corrida.origem].count++;

                // Por hora
                if (!porHora[corrida.hora]) {
                    porHora[corrida.hora] = { total: 0, count: 0 };
                }
                porHora[corrida.hora].total += corrida.valor;
                porHora[corrida.hora].count++;

                // Por dia
                const dias = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
                const nomeDia = dias[corrida.diaSemana];
                if (!porDia[nomeDia]) {
                    porDia[nomeDia] = { total: 0, count: 0 };
                }
                porDia[nomeDia].total += corrida.valor;
                porDia[nomeDia].count++;
            });

            const criarRanking = (dados) => {
                return Object.entries(dados)
                    .map(([key, value]) => ({
                        nome: key,
                        media: (value.total / value.count).toFixed(2),
                        quantidade: value.count
                    }))
                    .sort((a, b) => parseFloat(b.media) - parseFloat(a.media))
                    .slice(0, 5);
            };

            const renderizarCard = (items, containerId) => {
                document.getElementById(containerId).innerHTML = items.map(item => `
                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg border-l-4 border-green-500">
                        <div>
                            <div class="font-semibold text-gray-800 text-sm">${item.nome}</div>
                            <div class="text-xs text-gray-600">${item.quantidade} corridas</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-green-700">R$ ${item.media}</div>
                            <div class="text-xs text-gray-500">m√©dia</div>
                        </div>
                    </div>
                `).join('');
            };

            renderizarCard(criarRanking(porOrigem), 'melhores-locais');
            renderizarCard(criarRanking(porHora).map(h => ({...h, nome: h.nome + ':00h'})), 'melhores-horarios');
            renderizarCard(criarRanking(porDia), 'melhores-dias');
        }

        // Excluir corrida
        function excluirCorreida(id) {
            if (confirm('Deseja excluir esta corrida?')) {
                corridasCapturadas = corridasCapturadas.filter(c => c.id !== id);
                printsArmazenados = printsArmazenados.filter(p => p.id !== id);
                salvarDados();
                atualizarInterface();
            }
        }

        // Event listeners
        uploadInput.addEventListener('change', (e) => {
            const arquivo = e.target.files[0];
            if (arquivo) {
                processarScreenshot(arquivo);
            }
        });

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            carregarDados();
            
            // PWA Installation
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(() => console.log('Service Worker registrado'))
                    .catch(() => console.log('Service Worker falhou'));
            }
        });

        // Teste inicial (remover em produ√ß√£o)
        console.log('‚úÖ App carregado com sucesso!');
    </script>

</body>
</html>
